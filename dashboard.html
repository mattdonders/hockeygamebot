<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèí Hockey Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .team-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4b5563;
        }

        .team-select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 14px;
            min-width: 180px;
        }

        .bots-grid-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        .bots-grid-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #111827;
        }

        .bots-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .bots-grid th {
            text-align: left;
            padding: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .bots-grid td {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }

        .bots-grid .cell-muted {
            color: #6b7280;
        }

        .bots-grid-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .bots-grid-status-running {
            background: #d1fae5;
            color: #065f46;
        }

        .bots-grid-status-starting {
            background: #fef3c7;
            color: #92400e;
        }

        .bots-grid-status-idle {
            background: #e5e7eb;
            color: #374151;
        }

        .bots-grid-status-error {
            background: #fee2e2;
            color: #991b1b;
        }


        @media (max-width: 900px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        .header h1 {
            font-size: 28px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-running {
            background: #10b981;
            color: white;
        }

        .status-sleeping {
            background: #6366f1;
            color: white;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        .status-stopped {
            background: #6b7280;
            color: white;
        }

        .status-starting {
            background: #f59e0b;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .last-update {
            font-size: 14px;
            color: #6b7280;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .game-card-full {
            margin-bottom: 16px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            white-space: nowrap;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            text-align: right;
        }

        .game-score {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            margin-bottom: 16px;
        }

        .team-score {
            text-align: center;
        }

        .team-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
        }

        .vs {
            font-size: 20px;
            opacity: 0.8;
        }

        .event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .event-stat {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .event-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }

        .event-stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .health-good {
            color: #10b981;
            font-weight: 600;
        }

        .health-bad {
            color: #ef4444;
            font-weight: 600;
        }

        .issues-list {
            list-style: none;
            margin-top: 12px;
        }

        .issues-list li {
            padding: 8px 12px;
            background: #fef2f2;
            border-left: 3px solid #ef4444;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
            color: #991b1b;
        }

        .no-game {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 18px;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6b7280;
        }

        .period-info {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .period-label {
            font-size: 14px;
            color: #6b7280;
        }

        .period-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        /* JSON debug card */
        .json-card .json-details {
            margin-top: 8px;
        }

        .json-card .json-details summary {
            cursor: pointer;
            font-weight: 600;
            list-style: none;
            margin-bottom: 4px;
        }

        .json-card .json-block {
            background: #111827;
            color: #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            max-height: 320px;
            overflow: auto;
            margin: 4px 0 8px;
        }

        .json-card .json-empty {
            font-size: 13px;
            color: #6b7280;
            margin: 4px 0 8px;
        }

        .cache-goals {
            margin-top: 12px;
        }

        .cache-goals-header {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .cache-goals-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 4px 8px;
            font-size: 12px;
        }

        .cache-goals-cell-head {
            font-weight: 600;
            color: #4b5563;
        }

        /* Responsive layout / mobile fixes */
        @media (max-width: 900px) {
            body {
                padding: 16px;
            }

            .container {
                max-width: 100%;
                padding: 16px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            /* Override inline grid-column on small screens */
            .grid .card {
                grid-column: auto !important;
            }

            .period-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üèí Hockey Bot Dashboard</h1>
                <div class="team-selector">
                    <span>Team:</span>
                    <select id="teamSelect" class="team-select">
                        <option value="">Loading‚Ä¶</option>
                    </select>
                </div>
            </div>
            <div>
                <div class="status-badge" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Loading...</span>
                </div>
                <div class="last-update" id="lastUpdate">Loading...</div>
            </div>
        </div>

        <!-- GLOBAL MULTI-BOT STATUS GRID -->
        <div class="bots-grid-container" id="botsGridContainer" style="display: none;">
            <div class="bots-grid-title">Active Game Bots</div>
            <table class="bots-grid" id="botsGrid">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Matchup</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="botsGridBody">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>



        <div id="content">
            <div class="loading">
                <div>Loading dashboard...</div>
            </div>
        </div>
    </div>

    <script>
        let lastFetchTime = null;
        let bots = [];
        let currentTeamSlug = null;
        let fetchIntervalId = null;

        async function loadBots() {
            const select = document.getElementById("teamSelect");

            let discoveredBots = [];

            try {
                const response = await fetch("/api/bots?t=" + Date.now());
                if (!response.ok) throw new Error("Failed to fetch /api/bots");

                discoveredBots = await response.json();
            } catch (err) {
                console.error("Error loading bots:", err);
                discoveredBots = [];
            }

            bots = discoveredBots;
            select.innerHTML = "";

            // No bots found
            if (bots.length === 0) {
                select.disabled = true;
                select.innerHTML = `<option value="">No active bots</option>`;
                return;
            }

            select.disabled = false;

            // Determine which team should be selected initially
            const params = new URLSearchParams(window.location.search);
            const urlTeam = (params.get("team") || "").trim().toLowerCase();

            let defaultSlug = urlTeam || currentTeamSlug;
            if (!defaultSlug || !bots.some((b) => b.slug === defaultSlug)) {
                defaultSlug = bots[0].slug;
            }
            currentTeamSlug = defaultSlug;

            // Fetch details from each bot
            for (let bot of bots) {
                try {
                    const statusResp = await fetch(bot.status_file + "?t=" + Date.now());
                    if (!statusResp.ok) throw new Error("Failed to fetch " + bot.status_file);

                    const statusData = await statusResp.json();

                    const botMeta = statusData.bot || {};
                    const game = statusData.game || {};

                    // status + last_updated (convert ISO string -> seconds since epoch)
                    bot.status = botMeta.status || "IDLE";

                    if (botMeta.last_update) {
                        const ms = Date.parse(botMeta.last_update);
                        bot.last_updated = isNaN(ms) ? null : Math.floor(ms / 1000);
                    } else {
                        bot.last_updated = null;
                    }

                    // matchup
                    bot.matchup =
                        game.away_team && game.home_team
                            ? `${game.away_team} @ ${game.home_team}`
                            : null;

                    // score (preferred vs other)
                    if (
                        statusData.preferredScore !== undefined &&
                        statusData.otherScore !== undefined
                    ) {
                        bot.score = `${statusData.preferredScore} - ${statusData.otherScore}`;
                    } else {
                        bot.score = null;
                    }
                } catch (err) {
                    console.error("Error loading status for", bot.slug, err);
                    bot.status = "ERROR";
                    bot.last_updated = null;
                    bot.matchup = null;
                    bot.score = null;
                }
            }

            // Build dropdown
            bots.forEach((bot) => {
                const opt = document.createElement("option");
                opt.value = bot.slug;
                opt.textContent = bot.label || bot.slug.toUpperCase();
                if (bot.slug === currentTeamSlug) opt.selected = true;
                select.appendChild(opt);
            });

            select.addEventListener("change", () => {
                currentTeamSlug = select.value;
                fetchStatus();
            });
        }



        function renderBotsGrid() {
            const container = document.getElementById("botsGridContainer");
            const tbody = document.getElementById("botsGridBody");

            if (!bots || bots.length === 0) {
                container.style.display = "none";
                return;
            }

            container.style.display = "block";
            tbody.innerHTML = "";

            bots.forEach((bot) => {
                const tr = document.createElement("tr");

                const statusClass = {
                    RUNNING: "bots-grid-status-running",
                    STARTING: "bots-grid-status-starting",
                    IDLE: "bots-grid-status-idle",
                    ERROR: "bots-grid-status-error",
                }[bot.status?.toUpperCase()] || "bots-grid-status-idle";

                const lastUpdated = bot.last_updated
                    ? formatSecondsAgo(bot.last_updated)
                    : "‚Äî";

                tr.innerHTML = `
                    <td>${bot.label || bot.slug.toUpperCase()}</td>
                    <td><span class="bots-grid-status ${statusClass}">${bot.status || "IDLE"}</span></td>
                    <td class="cell-muted">${lastUpdated}</td>
                    <td class="cell-muted">${bot.matchup || "‚Äî"}</td>
                    <td class="cell-muted">${bot.score || "‚Äî"}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function formatSecondsAgo(ts) {
            if (!ts) return "‚Äî";

            const now = Math.floor(Date.now() / 1000);
            const diff = Math.max(0, now - ts);

            if (diff < 5) return "just now";
            if (diff < 60) return `${diff}s ago`;

            const m = Math.floor(diff / 60);
            if (m < 60) return `${m}m ago`;

            const h = Math.floor(m / 60);
            const remM = m % 60;
            if (h < 24) {
                return remM > 0 ? `${h}h ${remM}m ago` : `${h}h ago`;
            }

            const d = Math.floor(h / 24);
            const remH = h % 24;
            return remH > 0 ? `${d}d ${remH}h ago` : `${d}d ago`;
        }



        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function formatTimestamp(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function timeSince(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');

            badge.className = 'status-badge status-' + status.toLowerCase();
            text.textContent = status;
        }

        function renderDashboard(data) {
            const bot = data.bot;
            const game = data.game;
            const events = data.events;
            const performance = data.performance;
            const errors = data.errors;
            const socials = data.socials;
            const health = data.health;

            const cache = data.cache || {};
            const cacheSummary = cache.summary || {};
            const cacheRaw = cache.raw || null;

            const pregame = (cacheRaw && cacheRaw.pregame_posts) || {};
            const pregameSent = pregame.sent || {};
            const pregameRoots = pregame.root_refs || {};

            const rootPlatformsText = Object.keys(pregameRoots).length
                ? Object.keys(pregameRoots).sort().join(", ")
                : "None";

            // Update header
            updateStatusBadge(bot.status);
            document.getElementById("lastUpdate").textContent =
                `Last Update: ${timeSince(bot.last_update)}`;

            let html = "";

            // =========================
            // Full-width Game Information / Score
            // =========================
            html += '<div class="card game-card-full">';
            html += '<div class="card-title">Game Information</div>';

            if (game.game_id && game.game_state !== null) {
                // Score Display
                if (game.home_team && game.away_team) {
                    html += '<div class="game-score">';
                    html += `<div class="team-score">
                                <div class="team-name">${game.away_team}</div>
                                <div class="score">${game.away_score || 0}</div>
                             </div>`;
                    html += '<div class="vs">@</div>';
                    html += `<div class="team-score">
                                <div class="team-name">${game.home_team}</div>
                                <div class="score">${game.home_score || 0}</div>
                             </div>`;
                    html += "</div>";
                }

                // Period and Time
                if (game.period || game.time_remaining) {
                    html += '<div class="period-info">';
                    html += `<div>
                                <div class="period-label">Period</div>
                                <div class="period-value">${game.period || "N/A"}</div>
                             </div>`;
                    html += `<div>
                                <div class="period-label">Time Remaining</div>
                                <div class="period-value">${game.time_remaining || "N/A"}</div>
                             </div>`;
                    html += `<div>
                                <div class="period-label">Intermission</div>
                                <div class="period-value">${game.in_intermission ? "Yes" : "No"}</div>
                             </div>`;
                    html += "</div>";
                }

                // Game Details
                html += `<div class="stat-row">
                            <span class="stat-label">Game ID</span>
                            <span class="stat-value">${game.game_id}</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Game State</span>
                            <span class="stat-value">${game.game_state}</span>
                         </div>`;
                if (game.venue) {
                    html += `<div class="stat-row">
                                <span class="stat-label">Venue</span>
                                <span class="stat-value">${game.venue}</span>
                             </div>`;
                }
            } else {
                html += '<div class="no-game">No active game</div>';
            }

            html += "</div>"; // end game-card-full

            // =========================
            // Row 2: Bot Stats & System Health
            // =========================
            html += '<div class="grid">';

            // Bot Stats Card
            html += '<div class="card">';
            html += '<div class="card-title">Bot Statistics</div>';
            html += `<div class="stat-row">
                        <span class="stat-label">Uptime</span>
                        <span class="stat-value">${formatUptime(bot.uptime_seconds)}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Live Loops</span>
                        <span class="stat-value">${performance.live_loop_count}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Started</span>
                        <span class="stat-value">${timeSince(bot.start_time)}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Last Loop</span>
                        <span class="stat-value">${timeSince(performance.last_loop_time)}</span>
                     </div>`;
            html += "</div>";

            // Health Card
            html += '<div class="card">';
            html += '<div class="card-title">System Health</div>';
            html += `<div class="stat-row">
                        <span class="stat-label">Status</span>
                        <span class="stat-value ${health.healthy ? "health-good" : "health-bad"}">
                            ${health.healthy ? "‚úì Healthy" : "‚úó Issues Detected"}
                        </span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Total Errors</span>
                        <span class="stat-value">${errors.count}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Last Error</span>
                        <span class="stat-value">${timeSince(errors.last_error_time)}</span>
                     </div>`;

            const issues = (health && Array.isArray(health.issues)) ? health.issues : [];

            if (!health.healthy && issues.length > 0) {
                html += '<ul class="issues-list">';
                issues.forEach((issue) => {
                    html += `<li>‚ö†Ô∏è ${issue}</li>`;
                });
                html += "</ul>";
            }

            if (errors.last_error) {
                html += `<div style="margin-top: 12px; padding: 8px; background: #fef2f2; border-radius: 4px; font-size: 12px; color: #991b1b;">
                            ${errors.last_error}
                         </div>`;
            }
            html += "</div>"; // end health card

            html += "</div>"; // end grid row 2

            // =========================
            // Row 3: Events / API / Social
            // =========================
            html += '<div class="grid">';

            // Events Card
            html += '<div class="card">';
            html += '<div class="card-title">Game Events Processed</div>';
            html += '<div class="event-grid">';

            const eventTypes = [
                { key: "total", label: "Total Events" },
                { key: "goals", label: "Goals" },
                { key: "penalties", label: "Penalties" },
                { key: "shots", label: "Shots" },
                { key: "saves", label: "Saves" },
                { key: "hits", label: "Hits" },
                { key: "blocks", label: "Blocks" },
                { key: "takeaways", label: "Takeaways" },
                { key: "giveaways", label: "Giveaways" },
                { key: "faceoffs", label: "Faceoffs" },
            ];

            eventTypes.forEach((event) => {
                html += `<div class="event-stat">
                            <div class="event-stat-value">${events[event.key]}</div>
                            <div class="event-stat-label">${event.label}</div>
                         </div>`;
            });

            html += "</div>";
            html += "</div>"; // end events card

            // API Performance Card
            html += '<div class="card">';
            html += '<div class="card-title">API Performance</div>';
            html += `<div class="stat-row">
                        <span class="stat-label">Total Calls</span>
                        <span class="stat-value">${performance.api_calls.total}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Successful</span>
                        <span class="stat-value" style="color: #10b981;">${performance.api_calls.successful}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Failed</span>
                        <span class="stat-value" style="color: #ef4444;">${performance.api_calls.failed}</span>
                     </div>`;
            const successRate =
                performance.api_calls.total > 0
                    ? (
                        (performance.api_calls.successful /
                            performance.api_calls.total) *
                        100
                    ).toFixed(1)
                    : 100;
            html += `<div class="stat-row">
                        <span class="stat-label">Success Rate</span>
                        <span class="stat-value">${successRate}%</span>
                     </div>`;
            html += "</div>";

            // Social Media Card
            const previewSent = Object.values(socials.preview_posts || {}).filter(
                (v) => v
            ).length;
            html += '<div class="card">';
            html += '<div class="card-title">Social Media</div>';
            html += `<div class="stat-row">
                        <span class="stat-label">Posts Sent</span>
                        <span class="stat-value">${socials.posts_sent}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Last Post</span>
                        <span class="stat-value">${timeSince(socials.last_post_time)}</span>
                     </div>`;
            html += `<div class="stat-row">
                        <span class="stat-label">Preview Posts</span>
                        <span class="stat-value">${previewSent}/4</span>
                     </div>`;
            html += "</div>";

            html += "</div>"; // end grid row 3

            // =========================
            // Row 4: Cache / Restart-Safe State (incl. pre-game)
            // =========================
            html += '<div class="grid">';
            html += '<div class="card">';
            html += '<div class="card-title">Cache / Restart-Safe State</div>';

            if (!cache.enabled || !cacheSummary) {
                html += '<p class="json-empty">Cache has not been initialized yet.</p>';
            } else {
                html += `<div class="stat-row">
                            <span class="stat-label">Enabled</span>
                            <span class="stat-value">${cache.enabled ? "Yes" : "No"}</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Season ID</span>
                            <span class="stat-value">${cacheSummary.season_id || "‚Äî"}</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Game ID</span>
                            <span class="stat-value">${cacheSummary.game_id || "‚Äî"}</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Team</span>
                            <span class="stat-value">${cacheSummary.team_abbrev || "‚Äî"}</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Processed Events</span>
                            <span class="stat-value">${cacheSummary.processed_events ?? 0
                    }</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Goal Snapshots</span>
                            <span class="stat-value">${cacheSummary.goal_snapshots ?? 0
                    }</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Last Sort Order</span>
                            <span class="stat-value">${cacheSummary.last_sort_order ?? "‚Äî"
                    }</span>
                         </div>`;
                html += `<div class="stat-row">
                            <span class="stat-label">Thread Roots</span>
                            <span class="stat-value">${rootPlatformsText}</span>
                         </div>`;

                // ---- Pre-game socials summary ----
                const pregameKinds = [
                    { key: "core", label: "Core Preview" },
                    { key: "season_series", label: "Season Series" },
                    { key: "team_stats", label: "Team Stats Chart" },
                    { key: "officials", label: "Officials" },
                ];

                html += '<div class="cache-goals" style="margin-top: 12px;">';
                html += '<div class="cache-goals-header">Pregame Socials</div>';
                html +=
                    '<div class="cache-goals-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">';

                html +=
                    '<div class="cache-goals-cell cache-goals-cell-head">Type</div>';
                html +=
                    '<div class="cache-goals-cell cache-goals-cell-head">Status</div>';

                pregameKinds.forEach((item) => {
                    const status = pregameSent[item.key] ? "Sent" : "Pending";
                    html += `<div class="cache-goals-cell">${item.label}</div>`;
                    html += `<div class="cache-goals-cell">${status}</div>`;
                });

                html += "</div>"; // grid
                html += "</div>"; // pregame section

                // ---- Goals in cache (existing) ----
                const goalSnapshots = (cacheRaw && cacheRaw.goal_snapshots) || {};
                const goalIds = Object.keys(goalSnapshots);
                if (goalIds.length > 0) {
                    goalIds.sort((a, b) => {
                        const sa = goalSnapshots[a].sort_order || 0;
                        const sb = goalSnapshots[b].sort_order || 0;
                        return sa - sb;
                    });

                    html += '<div class="cache-goals" style="margin-top: 16px;">';
                    html += '<div class="cache-goals-header">Goals in Cache</div>';
                    html += '<div class="cache-goals-grid">';
                    html +=
                        '<div class="cache-goals-cell cache-goals-cell-head">Event ID</div>';
                    html +=
                        '<div class="cache-goals-cell cache-goals-cell-head">Team</div>';
                    html +=
                        '<div class="cache-goals-cell cache-goals-cell-head">Sort Order</div>';
                    html +=
                        '<div class="cache-goals-cell cache-goals-cell-head">Posted</div>';

                    goalIds.forEach((id) => {
                        const g = goalSnapshots[id] || {};
                        html += `<div class="cache-goals-cell">${id}</div>`;
                        html += `<div class="cache-goals-cell">${g.team_abbrev || "‚Äî"
                            }</div>`;
                        html += `<div class="cache-goals-cell">${g.sort_order ?? "‚Äî"
                            }</div>`;
                        html += `<div class="cache-goals-cell">${g.posted ? "Yes" : "No"
                            }</div>`;
                    });

                    html += "</div>"; // cache-goals-grid
                    html += "</div>"; // cache-goals
                }
            }

            html += "</div>"; // end cache card
            html += "</div>"; // end grid row 4

            // Inject HTML
            document.getElementById("content").innerHTML = html;
        }



        function getStatusFileName() {
            if (currentTeamSlug) {
                return `status-${currentTeamSlug}.json`;
            }
            // Fallback for single-bot setups or legacy use
            return "status.json";
        }

        async function fetchStatus() {
            const statusFile = getStatusFileName();

            try {
                const response = await fetch(statusFile + "?t=" + Date.now());
                if (!response.ok) {
                    throw new Error("Failed to fetch " + statusFile);
                }
                const data = await response.json();
                lastFetchTime = Date.now();
                renderDashboard(data);
            } catch (error) {
                console.error("Error fetching status:", error);
                document.getElementById("content").innerHTML =
                    `<div class="error-message">
                    ‚ö†Ô∏è Error loading ${statusFile} ‚Äì Make sure the bot is running and ${statusFile} exists
                 </div>`;
            }
        }


        function escapeHtml(str) {
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }


        async function initDashboard() {
            await loadBots();
            renderBotsGrid();   // <-- GOOD RIGHT HERE

            if (!bots || bots.length === 0) {
                return;
            }

            await fetchStatus();

            fetchIntervalId = setInterval(() => {
                fetchStatus();
                renderBotsGrid();
            }, 2000);
        }

        initDashboard();
    </script>
</body>

</html>
